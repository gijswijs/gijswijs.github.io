<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content=""><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/ms-icon-144x144.png><meta name=theme-color content=#ffffff><title>Why does signature half aggregation break adaptor signatures?</title><link href=/styles/main.css rel=stylesheet><link rel=alternate type=application/rss+xml title="Gijs van Dam" href=/rss.xml><link rel=webmention href=https://webmention.io/www.gijsvandam.nl/webmention><link rel=pingback href=https://webmention.io/www.gijsvandam.nl/xmlrpc><link rel=authorization_endpoint href=https://janos-githubproxy.azurewebsites.net/api/authorize/gijswijs/gijswijs.github.io><link rel=token_endpoint href=https://janos-githubproxy.azurewebsites.net/api/token/gijswijs/gijswijs.github.io><link rel=microsub href=https://aperture.p3k.io/microsub/636><link rel=micropub href=https://janos-githubproxy.azurewebsites.net/api/micropub/gijswijs/gijswijs.github.io></head><body class="article h-entry"><header>Gijs van Dam<nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/research title=Research>Research</a></li><li><a href=/open-source title="Open Source">Open Source</a></li><li><a href=/ventures title=Ventures>Ventures</a></li><li><a href=/resume title=Resume>Resume</a></li><li><a href=/about title=About>About</a></li><li><a href=/now title=Now>Now</a></li><li><a href=/contact title=Contact>Contact</a></li></ul></nav></header><main><article><script>MathJax = {
            chtml: {
              scale: 1, // global scaling factor for all expressions
              minScale: 1, // smallest scaling factor to use
            }
          };</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><header><h1 class=p-name>Why does signature half aggregation break adaptor signatures?</h1><span><a class=u-url href=/post/why-does-signature-half-aggregation-break-adaptor-signatures><time class=dt-published datetime=2022-04-04T00:00:00Z>April 4, 2022</time></a> <span class=reading-time>6 minute read</span></span><ul><li><a class=p-category href=/topics/cryptography/ >cryptography</a></li><li><a class=p-category href=/topics/lightning-network/ >lightning network</a></li><li><a class=p-category href=/topics/bitcoin/ >bitcoin</a></li></ul></header><section class=e-content><p>There is this cool trick you can do with Schnorr signatures. It is called Adaptor Signature (AS). An adaptor signature is an extra signature that, combined with the original signature, allow for revealing a value that was previously hidden. You can use this trick to solve trust problems as they appear in atomic swaps, coin swaps and Discreet Log Contracts (DLCs).</p><p>Signature Aggregation (SA) is a way to aggregate multiple signatures into a single signature. The single aggregate signature is smaller (in bytes) than the original signatures combined. It reduces transaction weight, meaning we can have more transactions per block, which is always a good thing. It&#39;s like 7zip for transactions. Signature <em>Half</em> Aggregation is a variant of SA that only aggregates half of each signature. It offers less compression, but it has the benefit of not requiring any interaction with the signers, whereas full aggregation does require cooperation of all the signers.</p><p>So two cool tricks, but the latter breaks the former when it is used for blockwide signature aggregation. This article explains the math behind it and why SA breaks AS</p><h2 id=schnorr-signatures>Schnorr Signatures</h2><p>Let&#39;s start with a normal, vanilla signature, and then work our way up to adaptor signatures. To create a signature we need a public key and a private key. With Schnorr the private key is just an integer value somewhere between \(0\) and \(\sim2^{256}\). Let&#39;s call this private key <em>x</em>. The public key <em>P</em> belonging to <em>x</em> is then a special point on our elliptic curve added to itself <em>x</em> times. This point is called the <em>base point</em> or <em>generator</em>. We assign it the letter <em>G</em>. Adding a point <em>n</em> times to itself is the definition of multiplication, so we can capture our key-pair in this simple formula:</p><p>\[P=xG\]</p><p>You might be tempted to think that it might be easy to calculate the private key <em>x</em> if you know the public key <em>P</em> and the base point <em>G</em>, because \(x=\frac{P}{G}\). But while addition (and multiplication) over an elliptic curve is easy, division (undoing multiplication) is hard. In fact it is so hard, that it is completely infeasible to calculate the private key, given the public key. This is at the foundation of all elliptic curve cryptography.</p><p>Now let&#39;s sign a message with this private key, and validate the signature with the public key. To sign a message we need a <em>challenge</em> and a <em>nonce</em>. A nonce is a random number that we use only one time for signing a single message. We use the letter \(r\) to indicate our nonce. We calculate the public key \(R\) that pairs with \(r\). The challenge is a hash-value that depends on the message we are signing. It all fits together like this:</p><p>\[ \begin{align} R&amp;=rG \\ e&amp;=H(P||R||m) \end{align} \]</p><p>The hashing function is indicated by \(H()\) and it is chosen in such a way that it returns a value that of the same scale as our private keys. That is why SHA256 is a great choice for the hashing function. It&#39;s important to understand that a hash is <em>just</em> a number. We can us it as such and do some elliptic curve calculations with it to come up with our signature:</p><p>\[s=r + ex\]</p><p>The signature is published by the Signer as \((s, R)\).</p><p>A Verifier can now verify whether the Signer knows the private key \(x\). It only needs to know \(s\) and \(R\) (the signature) and the public key \(P\) of the signer, which is public by definition. The base point \(G\) is a published property of the elliptic curve. The challenge can be constructed by the verifier as well, since it only uses public information. To verify you have to calculate whether:</p><p>\[sG = R + Pe\]</p><p>The verification should fail if that equality doesn&#39;t hold.</p><p>It is easy to see why this is proof of the Signer knowing \(x\) and having used it to sign \(m\):</p><p>\[ \begin{align} sG &amp;= R + Pe \\ &amp;= rG + xGe \\ &amp;= (r + ex)G \end{align} \]</p><h2 id=adaptor-signatures>Adaptor Signatures</h2><p>Now let&#39;s crank things up a bit and create an adaptor signature. An adaptor signature is a normal Schnorr signature with an added secret tweak. This tweak is the secret we want to hide and only reveal upon revealing the signature. The tweak is indicated by the letter \(t\). Again, we calculate the public key belonging to \(t\) with \(T=tG\). The challenge and the signature are now slightly different because of the tweak:</p><p>\[ \begin{align} \\ e&amp;=H(P||R+T||m) \\ s&amp;=r+t+ex \end{align} \]</p><p>The adaptor signature \(s&#39;\) is the signature minus the secret tweak, so \(s&#39;=s-t\). instead of releasing the signature as we did with the vanilla Schnorr signature, we now published the adaptor signature as \((s&#39;,R,T)\).</p><p>The Verifier can still be sure that the Signer owns the secret key \(x\). Remember \(s&#39;=s-t\), so:</p><p>\[ \begin{align} s&#39;&amp;=s-t \\ &amp;=r+t+ex-t \\ &amp;=r+ex \end{align} \]</p><p>Which means that verification didn&#39;t really change for the Verifier. The Verifier only needs to add \(R\) and \(T\) because of the challenge, but apart from that verification remains the same:</p><p>\[s&#39;G = R + Pe\]</p><p>And the proof of the correctness is similar as well:</p><p>\[ \begin{align} s&#39;G &amp;= R + Pe \\ &amp;= rG + xGe \\ &amp;= (r + ex)G \end{align} \]</p><p>When the Verifier receives the untweaked signature \(s\) it can calculate the secret tweak: \(t=s-s&#39;\). Likewise, when the Signer releases the secret tweak, the Verifier can calculate the untweaked signature \(s=s&#39;+t\).</p><p>This construction is the building block of things like <a href=https://reyify.com/blog/flipping-the-scriptless-script-on-schnorr>private Coinswap</a>, and Cross-chain Swaps.</p><h2 id=signature-half-aggregation>Signature Half Aggregation</h2><p>Now, let&#39;s try to understand Signature Half Aggregation. The basic concept of Signature Half Aggregation is to take the \(i\) signatures \((s_{i}, R_{i})\) that we want to aggregate, and then concatenate all the \(R\)-values and sum all the\(s\)-values. But as it turned out, that construction <a href=https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2017-May/014306.html>wasn&#39;t safe</a>. But with a small adjustment we can make a construction that <em>is</em> safe. Instead of summing all the\(s\)-values, we sum up all the\(s\)-values <em>after</em> multiplying them with unpredictable values.</p><p>Assume we have \(n\) Schnorr signatures we want to aggregate. For each signature, we create an unpredictable value \(z_{i}\). So, for \(i = 1 .. n\) we calculate the following value:</p><p>\[z_{i}=H(P_{1}||R_{1}||m_{1}||...||P_{n}||R_{n}||m_{n}||i)\]</p><p>Our aggregate signature now becomes:</p><p>\[s_{agg}=\sum_{i=1}^{n}z_{i}s_{i}\]</p><p>The signature is published as \((s_{agg}, R_{1}...R_{n})\). It doesn&#39;t have to be one (or all) of the Signers of the original signatures that has to do the aggregation. It can be any third party because this construction is non-interactive. It doesn&#39;t require the cooperation of the Signers after they have published their own signature.</p><p>Verification now becomes slightly different, but it is still easy to prove its correctness:</p><p>\[ \begin{align} s_{agg}G &amp;= \sum_{i=1}^{n} z_{i}(R_{i}+P_{i}e_{i}) \\ &amp;= \sum_{i=1}^{n} z_{i}(r_{i}G+x_{i}Ge_{i}) \\ &amp;= \sum_{i=1}^{n} z_{i}(r_{i}+x_{i}e_{i})G \\ &amp;= \sum_{i=1}^{n} z_{i}s_{i}G \end{align} \]</p><h2 id=signature-half-aggregation-breaks-adaptor-signatures>Signature Half Aggregation Breaks Adaptor Signatures</h2><p>So why does Signature Half Agrregation when used for blockwide signature aggregation in Bitcoin break Adaptor Signatures? Well, we need that untweaked signature \(s\) to calculate the secret tweak \(t=s-s&#39;\). But the untweaked signature \(s\) is lost inside the aggregate signature \(s_{agg}\). The only thing we have is the tweaked signature \(s&#39;\), with \(R\) and \(T\), since those were given to us, but the untweaked signature \(s\) should have been revealed when published on-chain. Instead we are given the \(s_{agg}\) which allows us to verify that all inputs inside the block have been signed, but it doesn&#39;t allow us to know the exact value of \(s\).</p><p>And that&#39;s why Signature Half Aggregation breaks Adaptor Signatures.</p></section><div class=metadata><i class=icon-repost>&nbsp;</i> 1 repost <i class=icon-like>&nbsp;</i> 3 likes</div><ul class=reposts><li class="p-repost h-cite"><a href=https://twitter.com/BIG_ZPrize/status/1532212826407743488 class=u-url><div class="p-author h-card"><img src=https://webmention.io/avatar/pbs.twimg.com/320e513145d03307e7b6eee9ae93fc4730a72ef6219c52143eb51abe990d337a.jpg alt="BIG | ZPrize.io: Zero-Knowledge Proof Competition" title="BIG | ZPrize.io: Zero-Knowledge Proof Competition" class=u-photo> <a class="p-name u-url" href=https://twitter.com/BIG_ZPrize>BIG | ZPrize.io: Zero-Knowledge Proof Competition</a></div></a></li></ul><ul class=likes><li class="p-like h-cite"><a href=https://twitter.com/gijswijs/status/1510918866771529729#favorited-by-1210952893 class=u-url><div class="p-author h-card"><img src=https://webmention.io/avatar/pbs.twimg.com/dd646af6fe90ad0b6a28568c3b2e893b15fab3b6974fa0fbc82579dead4d5890.jpg alt=lightcoin.btc title=lightcoin.btc class=u-photo> <a class="p-name u-url" href=https://twitter.com/lightcoin>lightcoin.btc</a></div></a></li><li class="p-like h-cite"><a href=https://twitter.com/gijswijs/status/1510918802615451652#favorited-by-1452473728340660226 class=u-url><div class="p-author h-card"><img src=https://webmention.io/avatar/pbs.twimg.com/320e513145d03307e7b6eee9ae93fc4730a72ef6219c52143eb51abe990d337a.jpg alt="BIG | ZPrize.io: Zero-Knowledge Proof Competition" title="BIG | ZPrize.io: Zero-Knowledge Proof Competition" class=u-photo> <a class="p-name u-url" href=https://twitter.com/BIG_ZPrize>BIG | ZPrize.io: Zero-Knowledge Proof Competition</a></div></a></li><li class="p-like h-cite"><a href=https://twitter.com/gijswijs/status/1510918789403398144#favorited-by-96440501 class=u-url><div class="p-author h-card"><img src=https://webmention.io/avatar/pbs.twimg.com/867c2ada3295dcb91a44aeaa178acd3f9683eb5f6d50382fdf4940e8aee612d6.jpg alt="IPY (memeboy)üü© ‚ö°Ô∏èüåãüçåüçû ‚àû/21M üáÆüá©" title="IPY (memeboy)üü© ‚ö°Ô∏èüåãüçåüçû ‚àû/21M üáÆüá©" class=u-photo> <a class="p-name u-url" href=https://twitter.com/imanpyudha>IPY (memeboy)üü© ‚ö°Ô∏èüåãüçåüçû ‚àû/21M üáÆüá©</a></div></a></li></ul><a href=https://twitter.com/gijswijs/status/1510918789403398144 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918791940947969 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918794453319681 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918800178561035 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918802615451652 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918807032066052 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918811977129987 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918816905437188 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918821825048582 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918827449626629 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918832319504385 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918837453324293 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918843275018244 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918848580841473 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918851021910018 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918855564328969 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918861646090246 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918864326230016 class="u-syndication icon-twitter">twitter</a> <a href=https://twitter.com/gijswijs/status/1510918866771529729 class="u-syndication icon-twitter">twitter</a></article></main><footer><nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/research title=Research>Research</a></li><li><a href=/open-source title="Open Source">Open Source</a></li><li><a href=/ventures title=Ventures>Ventures</a></li><li><a href=/resume title=Resume>Resume</a></li><li><a href=/about title=About>About</a></li><li><a href=/now title=Now>Now</a></li><li><a href=/contact title=Contact>Contact</a></li></ul></nav><ul><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.github.com/gijswijs href=https://www.github.com/gijswijs rel="noreferrer noopener me" target=_blank title=Github>Github</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.linkedin.com/in/gijsvandam/ href=https://www.linkedin.com/in/gijsvandam/ rel="noreferrer noopener me" target=_blank title=LinkedIn>LinkedIn</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.researchgate.net/profile/Gijs_Van_Dam2 href=https://www.researchgate.net/profile/Gijs_Van_Dam2 rel="noreferrer noopener me" target=_blank title=ResearchGate>ResearchGate</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://bitcoinhackers.org/@gijswijs href=https://bitcoinhackers.org/@gijswijs rel="noreferrer noopener me" target=_blank title=Mastodon>Mastodon</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.twitter.com/gijswijs href=https://www.twitter.com/gijswijs rel="noreferrer noopener me" target=_blank title=Twitter>Twitter</a></div></li><li><a href=/feed rel=feed target=_self title=Stream>Stream</a></li><li><a href=/rss.xml rel="" target=_blank title=RSS>RSS</a></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://keybase.io/gijsvandam href=https://keybase.io/gijsvandam rel="noreferrer noopener me" target=_blank title=Keybase>Keybase</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://orcid.org/0000-0002-6188-6859 href=https://orcid.org/0000-0002-6188-6859 rel="noreferrer noopener me" target=_blank title=ORCID>ORCID</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content="https://scholar.google.com/citations?user=4dTcK4kAAAAJ&amp;hl=en" href="https://scholar.google.com/citations?user=4dTcK4kAAAAJ&amp;hl=en" rel="noreferrer noopener me" target=_blank title="Google Scholar">Google Scholar</a></div></li></ul><p>&copy; 2022 <a href=/ >Gijs van Dam</a>. Published with <a href=https://github.com/neumannjs/Janos>Janos</a>. Theme <a href=https://github.com/neumannjs/Miksa>Miksa</a>.</p></footer></body><script data-goatcounter=https://gijsvandam.goatcounter.com/count async src=//gc.zgo.at/count.js></script></html>