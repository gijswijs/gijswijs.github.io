<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content=""><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/ms-icon-144x144.png><meta name=theme-color content=#ffffff><title>The effect of multi-part payments on the Balance Disovery Attack</title><link href=/styles/main.css rel=stylesheet><link rel=alternate type=application/rss+xml title="Gijs van Dam" href=/rss.xml><link rel=webmention href=https://webmention.io/www.gijsvandam.nl/webmention><link rel=pingback href=https://webmention.io/www.gijsvandam.nl/xmlrpc><link rel=authorization_endpoint href=https://janos-githubproxy.azurewebsites.net/api/authorize/gijswijs/gijswijs.github.io><link rel=token_endpoint href=https://janos-githubproxy.azurewebsites.net/api/token/gijswijs/gijswijs.github.io><link rel=microsub href=https://aperture.p3k.io/microsub/636><link rel=micropub href=https://janos-githubproxy.azurewebsites.net/api/micropub/gijswijs/gijswijs.github.io></head><body class="article h-entry"><header>Gijs van Dam<nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/research title=Research>Research</a></li><li><a href=/open-source title="Open Source">Open Source</a></li><li><a href=/ventures title=Ventures>Ventures</a></li><li><a href=/resume title=Resume>Resume</a></li><li><a href=/about title=About>About</a></li><li><a href=/now title=Now>Now</a></li><li><a href=/contact title=Contact>Contact</a></li></ul></nav></header><main><article><script>MathJax = {
            chtml: {
              scale: 1, // global scaling factor for all expressions
              minScale: 1, // smallest scaling factor to use
            }
          };</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><header><h1 class=p-name>The effect of multi-part payments on the Balance Disovery Attack</h1><span><a class=u-url href=/post/the-effect-of-multi-part-payments-on-the-balance-disovery-attack><time class=dt-published datetime=2023-09-22T00:00:00Z>September 22, 2023</time></a> <span class=reading-time>8 minute read</span></span><ul><li><a class=p-category href=/topics/pss/ >PSS</a></li><li><a class=p-category href=/topics/lightning-network/ >lightning network</a></li><li><a class=p-category href=/topics/mpp/ >MPP</a></li><li><a class=p-category href=/topics/bda/ >BDA</a></li></ul></header><section class=e-content><p>My PhD research is mainly on the Balance Discovery Attack (BDA). The BDA was introduced (in academia) by <a href=https://doi.org/10.1145/3321705.3329812 title="On the Difficulty of Hiding the Balance of Lightning Network Channels (2019)">Herrera-Joancomart√≠ et al.</a>. In their paper they used the term balance discovery attack and balance disclosure attack interchangeably. Nowadays the term probing or probing attack is more commonly used, but I prefer BDA, so I&#39;ll keep using that while shouting at the clouds.</p><p>The BDA is an attack on privacy. It can be used to discover balances of payment channels, but when used over a longer period of time it can also be used to detect actual payments. These are things we want to keep private, so it is interesting to look at ways of preventing this data from being leaked. Multi-part payments, and more specifically Payments Split &amp; Switch (PSS) has some surprising effects that can prevent data from being leaked in ways that I will try to explain in this post.</p><h2 id=the-balance-discovery-attack>The Balance Discovery Attack</h2><p>As I explained in my post on <a href=/post/how-do-payments-in-lightning-network-work/ title="How do payments in Lightning Network work?">payments in Lightning Network</a>, it is the sender who determines the route to the receiver. Because the sender does not know the balances of the route it selected, it can inadvertently select a route that has a payment channel in it with not enough liquidity to relay the payment. The relaying node will signal this by returning an <code>InsufficientFunds</code> or <code>TemporaryChannelFailure</code> error. If the sender succeeds in finding a route with enough liquidity, the payment goes through. But what if the sender uses a random payment hash, not used by any invoice? In that case if the sender finds a route with enough liquidity, the receiver returns with an <code>UnknownPaymentHash</code> error. This is the trick of the BDA: By using a random payment hash, the sender can distinguish between enough liquidity and insufficient liquidity without having to make a payment that actually succeeds.</p><p>By continuously probing the exact same route with different amounts and by choosing those amounts wisely i.e. via a binary search algorithm, the attacker can determine the exact balance of a payment channel with a precision of up to one millisatoshi.</p><h2 id=source-based-routing>Source-based routing</h2><p>If the the sender in LN wasn&#39;t the one who determined the route, (and didn&#39;t knew exactly through which channels a payment travels) the BDA wouldn&#39;t be possible. But LN uses source-based routing, and the network acts like an old-fashioned circuit-switched network, and so the BDA is possible. LN works like this because of privacy. The sender doesn&#39;t want to divulge the receiver, so it can&#39;t include the receiver in the header of a &quot;payment package&quot; like would be the case in a packet-switched network. Privacy, as always, is a trade-off and in this case the requirement of keeping the receiver hidden opens LN up for the BDA, which leaks information about the amount paid.</p><h2 id=parallel-channels>Parallel Channels</h2><p>But there&#39;s a case where the sender doesn&#39;t exactly knows which channel a payment takes. This is the case where a payment traverses between two nodes that have multiple channels between them. Nodes open new channels between them e.g. if a channel is depleted on one side. The node on that side wants to send payments while keeping the ability to receive payments through the depleted channel, so it opens a new channel.</p><p>When two nodes having a hop between them with multiple channels receive a request for relaying a payment, they are free to choose either channel between them to forward the payment, as long as the balance allows for it. Earlier work on BDAs didn&#39;t appreciate this fact, but <a href=https://link.springer.com/book/9783031182846 title="Analysis and Probing of Parallel Channels in the Lightning Network">Alex Biryukov et al.</a> wrote a great paper exploring the effects of parallel channels on BDAs, and showed that parallel channels decrease the amount of information that can be obtained by an attacker mounting a BDA.</p><h2 id=link-mpp-pss-and-bda>Link MPP, PSS and BDA</h2><p>Although an attacker can&#39;t be certain which channel is used in a hop with parallel channels (and I&#39;m glossing over some details here), in Alex&#39;s model the attacker still assumes that a payment goes through one single channel. But if a hop would use Link MPP or better yet PSS, an attacker couldn&#39;t even make that assumption. The relaying node is free to split up the payment as it sees fit, and the next node reassembles the parts and forwards the payment. (For more info on multi-part payments like Link MPP and PSS, please read my post <a href=/post/all-types-of-multi-part-payments-in-lightning-network-explained/ title="All types of multi-part payments in Lightning Network explained">explaining all MPPs</a>)</p><p>If the assumption that a payment travels through a single channel can&#39;t be made, life becomes a lot harder for the attacker. Because interpreting the results from a BDA becomes a problem of solving a system of mutiple linear inequalities. To explain, I first need to introduce Alex Biryukov&#39;s generalized geometrical model.</p><h3 id=generalized-geometrical-model>Generalized Geometrical Model</h3><p>The geometrical model is a model where all parallel channels in a hop are represented by a (hyper-)rectangle. Each dimension of this object represents a single channel. So a hop with just a single channel is represented by a line from zero to the capacity of the channel, a hop with two parallel channels is represented by a rectangle with one vertex at the origin and the opposit vertex at the point that lies at the coordinate of of the capacities of both channels, a hop with three parallel channels is represented by a cube and so on. Let&#39;s take a hop with two channels as an example and imagine the rectangle that represents it. Each point inside the rectangle is a possible combination of the two balances.</p><p>For now, let&#39;s assume payments go through single channels (no MPP yet). A probe gives us information with which we can adapt our geometrical object. A succesful probe means that the balances of both channels can&#39;t <em>both</em> be lower than the probing amount. So we can cut away a square from our rectangle that has sides equal to the probing amount. Depending on the probing direction, that square has its lower left vertex at the origin, or its upper right vertex at the upper right vertex of our rectangle. However, if the probe failed we know for sure that both balances are inadequate for relaying the probe. So instead of cutting the square away, we now know for sure that the balances of both channels lie with that square. So probing parallel channels becomes a game of chipping away squares, or chipping away everything outside the square, from the original rectangle.</p><p>After a full BDA of parallel channels, you don&#39;t necessarily get the exact balance, but you get a small set of possible balances. The set being smaller if the dimensions (the number of parallel channels) are lower.</p><h3 id=the-geometrical-model-with-pss>The Geometrical Model with PSS</h3><p>But when we introduce PSS into the mix, things start to get interesting. Not only does PSS allow for alternative routes (that introduce extra hops), it also allows for payment splitting over different hops. And all this <em>without</em> the sender knowing any of it. So from the perspective of the attacker in a BDA, a lot of uncertainty is introduced. Firstly, although the attacker is still the one who creates the route (it&#39;s still source-based routing after all), the attacker does need to consider alternative routes from one node to the next for each hop in the route. Secondly, the attacker needs to consider every possible split of payment over the possible routes from one hop to the next.</p><p>We can still capture this in a geometrical model. Again we start with a (hyper-)rectangle. But instead of the parallel channels in a hop, we need to consider all routes possible routes from one node to the next. But here the attacker has to make an assumption, with regards to the length of the routes it is willing to consider. In my research I made the assumption that PSS was only feasible over alternative routes with one intermediary hop. Every possible route from one hop to the next is now a dimension of our (hyper-)rectangle. This includes all parallel channels if there are any, but now also alternative routes with a single intermediary hop.</p><p><picture><source srcset="/images/geo-pss-start_s.avif 381w,/images/geo-pss-start_m.avif 571w,/images/geo-pss-start_l.avif 761w" type=image/avif><source srcset="/images/geo-pss-start_s.webp 381w,/images/geo-pss-start_m.webp 571w,/images/geo-pss-start_l.webp 761w" type=image/webp><img srcset="/images/geo-pss-start_s.jpg 381w,/images/geo-pss-start_m.jpg 571w,/images/geo-pss-start_l.jpg 761w" src=/images/geo-pss-start_s.jpg alt="The geometrical model assuming PSS" title="The geometrical model assuming PSS" loading=lazy decoding=async width=761 height=765><figcaption>The geometrical model assuming PSS</figcaption></picture></p><p>The attacker also needs to change it interpretation of the probing results. A sucessful probe is still grounds for adjusting the lower bounds, but before we could cut away a rectangle (the balances of both channels can&#39;t <em>both</em> be lower than the probing amount). But with PSS it&#39;s different. A succesful probe in PSS means that the balances of both channels can&#39;t <em>together</em> be lower than the probing amount. Geometrically this means we can cut away a triangle containing all points in our (hyper-)rectangle that <em>together</em> are less than the probing amount. A failed probe indicates an upper bound where we can cut away all points that <em>together</em> are more than the probing amount.</p><p><picture><source srcset="/images/geo-pss-after-probes_s.avif 381w,/images/geo-pss-after-probes_m.avif 571w,/images/geo-pss-after-probes_l.avif 761w" type=image/avif><source srcset="/images/geo-pss-after-probes_s.webp 381w,/images/geo-pss-after-probes_m.webp 571w,/images/geo-pss-after-probes_l.webp 761w" type=image/webp><img srcset="/images/geo-pss-after-probes_s.jpg 381w,/images/geo-pss-after-probes_m.jpg 571w,/images/geo-pss-after-probes_l.jpg 761w" src=/images/geo-pss-after-probes_s.jpg alt="The geometrical model after a sucessful and failed probe" title="The geometrical model after a sucessful and failed probe" loading=lazy decoding=async width=761 height=765><figcaption>The geometrical model after a sucessful and failed probe</figcaption></picture></p><p>So instead of chipping away squares we are now chipping away triangles that are half the size of those squares. A BDA still reduces the set of possible balances quite drastically, but it does it less than without the assumption of PSS. In other words, a (hyper-)rectangle with the same amount of dimensions and the same size is reduced to a bigger set with the assumption of PSS. Moreover, the (hyper-)rectangle have more dimensions to begin with because of the alternative routes that need to be considered, making the resulting set of possible balances even bigger than that set in the same setting but without PSS.</p><h2 id=computational-cost>Computational Cost</h2><p>So PSS makes BDA less effective, but also computationally more expensive. The old BDA algorithms are pretty much just binary searches with a time complexity of \(O(\log n)\). But with PSS the counting the coordinates (or lattice points as the cool kids call them) in that (hyper-)rectangle while chipping away (hyper-)triangles becomes increasingly complex, and the main bottle neck for the whole BDA algorithm.</p><p>We can describe the (hyper-)rectangle with the cut-away triangles as a system of mutiple linear inequalities. For each dimension (let&#39;s say a 3-dimensional cube with dimensions x,y and z) we can describe the cube itself with six inequalities:</p><p>\[ \begin{align} x &amp; &gt; -1 \\ x &amp; \leq c_x \\ y &amp; &gt; -1 \\ y &amp; \leq c_y \\ z &amp;&gt; -1 \\ z &amp; \leq c_z \\ \end{align} \]</p><p>Where \(c_x, c_y, c_z\) are the capacities of the channels represented by that dimension. Given a succesful probe and a failed probe for the amounts \(a_s\) and \(a_f\), we can add two inequalities:</p><p>\[ \begin{align} x + y + z &amp; &gt; a_s \\ x + y + z &amp; \leq a_f \\ \end{align} \]</p><p>The set of points that satisfy <em>all</em> inequalities is the set of possible balances. Finding this set is a problem of counting lattice points in a convex polytope. A polytope is a fancy word for objects with flat sides. Convex means it doesn&#39;t curve inwards on itself: the shape doesn&#39;t have any &quot;dents&quot;. Barvinok created an <a href=https://pubsonline.informs.org/doi/10.1287/moor.19.4.769 title="A Polynomial Time Algorithm for Counting Integral Points in Polyhedra When the Dimension is Fixed">algorithm</a> for counting points in such shapes that runs in polynomial time. So now our BDA algorithm bumps up from \(O(\log n)\) to \(O(n^{c})\) just because of the counting of the points in our weird hypershape.</p><h2 id=summary>Summary</h2><p>So that&#39;s the bottomline: PSS makes BDA less effective (the resulting set of possible balances is bigger than before) and computationally way more complex.</p><p>If you got this far, maybe you would also like to get really deep into the weeds and read my preprint on exactly this topic. You can find it at the <a href=https://eprint.iacr.org/2023/1360 title="Payment Splitting in Lightning Network as a Mitigation Against Balance Discovery Attacks">Cryptology ePrint Archive</a></p></section></article></main><footer><nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/research title=Research>Research</a></li><li><a href=/open-source title="Open Source">Open Source</a></li><li><a href=/ventures title=Ventures>Ventures</a></li><li><a href=/resume title=Resume>Resume</a></li><li><a href=/about title=About>About</a></li><li><a href=/now title=Now>Now</a></li><li><a href=/contact title=Contact>Contact</a></li></ul></nav><ul><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.github.com/gijswijs href=https://www.github.com/gijswijs rel="noreferrer noopener me" target=_blank title=Github>Github</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.linkedin.com/in/gijsvandam/ href=https://www.linkedin.com/in/gijsvandam/ rel="noreferrer noopener me" target=_blank title=LinkedIn>LinkedIn</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.researchgate.net/profile/Gijs_Van_Dam2 href=https://www.researchgate.net/profile/Gijs_Van_Dam2 rel="noreferrer noopener me" target=_blank title=ResearchGate>ResearchGate</a></div></li><li><a href=/feed rel=feed target=_self title=Stream>Stream</a></li><li><a href=/rss.xml rel="" target=_blank title=RSS>RSS</a></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://keybase.io/gijsvandam href=https://keybase.io/gijsvandam rel="noreferrer noopener me" target=_blank title=Keybase>Keybase</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://orcid.org/0000-0002-6188-6859 href=https://orcid.org/0000-0002-6188-6859 rel="noreferrer noopener me" target=_blank title=ORCID>ORCID</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content="https://scholar.google.com/citations?user=4dTcK4kAAAAJ&amp;hl=en" href="https://scholar.google.com/citations?user=4dTcK4kAAAAJ&amp;hl=en" rel="noreferrer noopener me" target=_blank title="Google Scholar">Google Scholar</a></div></li></ul><p>&copy; 2024 <a href=/ >Gijs van Dam</a>. Published with <a href=https://github.com/neumannjs/Janos>Janos</a>. Theme <a href=https://github.com/neumannjs/Miksa>Miksa</a>.</p></footer></body><script data-goatcounter=https://gijsvandam.goatcounter.com/count async src=//gc.zgo.at/count.js></script></html>