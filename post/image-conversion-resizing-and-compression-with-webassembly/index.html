<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content=""><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/ms-icon-144x144.png><meta name=theme-color content=#ffffff><title>Image conversion, resizing and compression with WebAssembly</title><link href=/styles/main.css rel=stylesheet><link rel=alternate type=application/rss+xml title="Gijs van Dam" href=/rss.xml><link rel=webmention href=https://webmention.io/www.gijsvandam.nl/webmention><link rel=pingback href=https://webmention.io/www.gijsvandam.nl/xmlrpc><link rel=authorization_endpoint href=https://janos-githubproxy.azurewebsites.net/api/authorize/gijswijs/gijswijs.github.io><link rel=token_endpoint href=https://janos-githubproxy.azurewebsites.net/api/token/gijswijs/gijswijs.github.io><link rel=microsub href=https://aperture.p3k.io/microsub/636><link rel=micropub href=https://janos-githubproxy.azurewebsites.net/api/micropub/gijswijs/gijswijs.github.io></head><body class="article h-entry"><header>Gijs van Dam<nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/research title=Research>Research</a></li><li><a href=/open-source title="Open Source">Open Source</a></li><li><a href=/ventures title=Ventures>Ventures</a></li><li><a href=/resume title=Resume>Resume</a></li><li><a href=/about-me title=About>About</a></li><li><a href=/what-am-i-doing-now title=Now>Now</a></li><li><a href=/contact title=Contact>Contact</a></li></ul></nav></header><main><article><header><h1 class=p-name>Image conversion, resizing and compression with WebAssembly</h1><span><a class=u-url href=/post/image-conversion-resizing-and-compression-with-webassembly><time class=dt-published datetime=2021-03-31T00:00:00Z>March 31, 2021</time></a> <span class=reading-time>5 minute read</span></span><ul><li><a class=p-category href=/topics/webassembly/ >webassembly</a></li><li><a class=p-category href=/topics/janos/ >janos</a></li></ul></header><section class=e-content><p>Image conversion and resizing for the web can be quite fiddly. Take responsive websites for instance. You want to show a smaller version of your image on smaller devices: You don&#39;t need to download a 1080px wide image to show on a 360px wide device, especially since that device is likely constrained in the amount of bandwidth it has. Then again when your website is shown on an ultra HD screen with 3840x2160 resolution 1080 is maybe even too small.</p><p>Apart from multiple sizes, you also want to offer multiple formats. Modern browsers support new(er) image formats like webp and avif offer better compression for comparable image quality. Using these formats you can decrease the total download size of your page, while improving the overall experience for the user. But you just can&#39;t assume (yet) that all browsers support those newer formats, so you have to provide older formats as a fallback option. All in all the amount of different files you have to offer for just a single image on a web page starts to become quite large and the whole thing becomes, like I said, fiddly.</p><p>Now look at the gif below.</p><p><picture><img src=/images/copy-paste-image.gif alt="animated gif of copy-pasting images with Janos" title="Copy-pasting an image in Janos" loading=lazy decoding=async width=888 height=662><figcaption>Copy-pasting an image in Janos</figcaption></picture></p><p>What is happening here? The gif shows the process of screen clipping an image and then pasting it inside the Janos editor. Upon pasting the image, the image is &quot;uploaded&quot;, and that starts a process of resizing and conversion. I use scare quotes around <em>uploaded</em>, because there isn&#39;t anything uploaded yet. Janos uses a small git client under the hood that stores the file in memory as a git blob. Only after committing to GitHub files are really uploaded to the GitHub servers. The pasted image is resized to three different sizes and three different formats (avif, webp and jpg), so in total 9 versions of the image are created. The original image is also stored in all its unresized greatness, making the total amount of files a nice 10. If the original image is copy-pasted like in the example above, it is stored as a png file. If the image is &quot;uploaded&quot; as a file it&#39;s kept as-is.</p><p>This workflow takes the fiddle out of fiddly and leaves us with a nice process of putting images inside a post without hassle. But the attentive reader might ask:</p><blockquote><p>How does this work? -- Attentive reader</p></blockquote><p>Since an actual upload hasn&#39;t happened yet, this whole process has to take place inside the browser and it uses WebAssembly to make it happen.</p><h2 id=conversion-and-resizing-with-webassembly>Conversion and resizing with WebAssembly</h2><p>GoogleChromeLabs has made the <a href=https://github.com/GoogleChromeLabs/squoosh>Squoosh app</a>, an amazing web app that offers image compression in all the formats you want. It also offers a Squoosh cli for compressing multiple files at once. I forked Squoosh and made a simple (and hacky) version of the Squoosh cli that runs in the browser. It is like a <em>headless</em> version of the Squoosh app, if you will. For each format Squoosh supports, it uses a codec (did you know codec is a portmanteau of coder-decoder?) developed in either Rust or C++ and compiled to WebAssembly. So this enables the browser to do some pretty heavy lifting with regards to resizing and converting our image. If I run it on my laptop I can hear the fans spin up to cope with the demands of the cpu.</p><h2 id=from-markdown-to-html>From Markdown to html</h2><p>After pasting the image, the Markdown syntax for inserting an image is pasted in the document with a reference to the original file. But that is obviously not the file we want to show in the resulting HTML. In our HTML we want an picture element that contains all our files in all formats and sizes. It should look like this:</p><pre><code class=language-html>&lt;picture
  &gt;&lt;source
    srcset=&quot;
      /images/ever-given_s.avif 461w,
      /images/ever-given_m.avif 692w,
      /images/ever-given_l.avif 922w
    &quot;
    type=&quot;image/avif&quot; /&gt;
  &lt;source
    srcset=&quot;
      /images/ever-given_s.webp 461w,
      /images/ever-given_m.webp 692w,
      /images/ever-given_l.webp 922w
    &quot;
    type=&quot;image/webp&quot; /&gt;
  &lt;img
    srcset=&quot;
      /images/ever-given_s.jpg 461w,
      /images/ever-given_m.jpg 692w,
      /images/ever-given_l.jpg 922w
    &quot;
    src=&quot;/images/ever-given_s.jpg&quot;
    alt=&quot;Container ship Ever Given&quot;
    title=&quot;Container ship Ever Given stuck in the Suez Canal&quot;
    loading=&quot;lazy&quot;
    decoding=&quot;async&quot;
    width=&quot;922&quot;
    height=&quot;480&quot;
/&gt;&lt;/picture&gt;
&lt;figcaption&gt;/images/todo-tree.jpg&lt;/figcaption&gt;</code></pre><p>The above snippet is derived from this <a href=https://www.stefanjudis.com/snippets/a-picture-element-to-load-correctly-resized-webp-images-in-html/ >snippet</a> with some minor adjustments. It uses <code>srcSet</code> to offer the different sizes of the image. It uses different <code>srcSet</code> to offer the different formats, and it uses <code>src</code> to offer the smallest version to browsers that don&#39;t support any of it. Since <a href=https://www.smashingmagazine.com/2020/03/setting-height-width-images-important-again/ >width &amp; height are important</a> for rendering pages fast without layout shifts, we add the width and height from the <em>largest</em> version of the image. This did result in some problems that took quite some time to get figured out:</p><p>Apparently the use of <code>width</code> and <code>height</code> nullifies any use of the <code>sizes</code> attribute in combination with the <code>srcSet</code>. The <code>sizes</code> attribute is meant for defining a set of media conditions (e.g. screen widths) and indicates what image size would be best to choose. The browser uses that info in combination with other information (like device-pixel-ratio) to determine which image file it will download. But because we want to use <code>width</code> and <code>height</code> this means that the <code>sizes</code> attribute is unavailable to us. So we are forced to use good ol&#39; css to indicate the different image sizes under different media conditions.</p><pre><code class=language-css>.article img {
  max-width: 100%;
  height: auto;
}
figcaption {
  text-align: center;
  margin-top: -1.5rem;
  font-style: italic;
}
@media (min-width: 40rem) {
  .article img {
    max-width: calc(100% - 6rem);
    height: auto;
    margin: 0 3rem;
  }
}
@media (min-width: 80rem) {
  .article img {
    max-width: calc(100% - 12rem);
    height: auto;
    margin: 0 6rem;
  }
}</code></pre><h2 id=metalsmith-plugin-for-the-picture-element>Metalsmith plugin for the picture element</h2><p>The final ingredient in this mix is a metalsmith plugin that creates the HTML picture element, based on the image referenced in the Markdown. It detects the image, figures out what kind of resized files are available and then converts the Markdown to a picture element. So in the end the picture will look like this:</p><p><picture><source srcset="/images/ever-given_s.avif 540w,/images/ever-given_m.avif 810w,/images/ever-given_l.avif 1080w" type=image/avif><source srcset="/images/ever-given_s.webp 540w,/images/ever-given_m.webp 810w,/images/ever-given_l.webp 1080w" type=image/webp><img srcset="/images/ever-given_s.jpg 540w,/images/ever-given_m.jpg 810w,/images/ever-given_l.jpg 1080w" src=/images/ever-given_s.jpg alt="Container ship Ever Given" title="Container ship Ever Given stuck in the Suez Canal" loading=lazy decoding=async width=1080 height=609><figcaption>Container ship Ever Given stuck in the Suez Canal</figcaption></picture></p><h2 id=releasing-everything-as-separate-modules>Releasing everything as separate modules</h2><p>Currently everything is integrated inside the Janos code base. But I plan on releasing both the <em>headless</em> Squoosh library and the Metalsmith plugin as separate npm modules. When that is done and dusted I will do write-up on how to use and configure said modules to suit your needs.</p></section></article></main><footer><nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/research title=Research>Research</a></li><li><a href=/open-source title="Open Source">Open Source</a></li><li><a href=/ventures title=Ventures>Ventures</a></li><li><a href=/resume title=Resume>Resume</a></li><li><a href=/about-me title=About>About</a></li><li><a href=/what-am-i-doing-now title=Now>Now</a></li><li><a href=/contact title=Contact>Contact</a></li></ul></nav><ul><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.github.com/gijswijs href=https://www.github.com/gijswijs rel="noreferrer noopener me" target=_blank title=Github>Github</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.linkedin.com/in/gijsvandam/ href=https://www.linkedin.com/in/gijsvandam/ rel="noreferrer noopener me" target=_blank title=LinkedIn>LinkedIn</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.researchgate.net/profile/Gijs_Van_Dam2 href=https://www.researchgate.net/profile/Gijs_Van_Dam2 rel="noreferrer noopener me" target=_blank title=ResearchGate>ResearchGate</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://bitcoinhackers.org/@gijswijs href=https://bitcoinhackers.org/@gijswijs rel="noreferrer noopener me" target=_blank title=Mastodon>Mastodon</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.twitter.com/gijswijs href=https://www.twitter.com/gijswijs rel="noreferrer noopener me" target=_blank title=Twitter>Twitter</a></div></li><li><a href=/rss.xml rel="" target=_blank title=RSS>RSS</a></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://keybase.io/gijsvandam href=https://keybase.io/gijsvandam rel="noreferrer noopener me" target=_blank title=Keybase>Keybase</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://orcid.org/0000-0002-6188-6859 href=https://orcid.org/0000-0002-6188-6859 rel="noreferrer noopener me" target=_blank title=ORCID>ORCID</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content="https://scholar.google.com/citations?user=4dTcK4kAAAAJ&amp;hl=en" href="https://scholar.google.com/citations?user=4dTcK4kAAAAJ&amp;hl=en" rel="noreferrer noopener me" target=_blank title="Google Scholar">Google Scholar</a></div></li></ul><p>&copy; 2021 <a rel=author class="p-author h-card" href=/ >Gijs van Dam</a>. Published with <a href=https://github.com/neumannjs/Janos>Janos</a>. Theme <a href=https://github.com/neumannjs/Miksa>Miksa</a>.</p></footer></body><script data-goatcounter=https://gijsvandam.goatcounter.com/count async src=//gc.zgo.at/count.js></script></html>