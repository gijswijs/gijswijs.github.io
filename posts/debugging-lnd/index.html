<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content=""><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/ms-icon-144x144.png><meta name=theme-color content=#ffffff><title>Debugging LND while running a local cluster</title><link href=/styles/vendor.css rel=stylesheet><link href=/styles/app.css rel=stylesheet></head><body class=article><header><h1>Gijs van Dam</h1><nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/pages/research title=Research>Research</a></li><li><a href=/pages/opensource title="Open Source">Open Source</a></li><li><a href=/pages/ventures title=Ventures>Ventures</a></li><li><a href=/pages/resume title=Resume>Resume</a></li><li><a href=/pages/about title=About>About</a></li><li><a href=/pages/now title=Now>Now</a></li><li><a href=/pages/contact title=Contact>Contact</a></li></ul></nav></header><main><article><script>MathJax = {
          chtml: {
              scale: 1,                      // global scaling factor for all expressions
              minScale: 1,                  // smallest scaling factor to use
            }
          };</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><header><h1>Debugging LND while running a local cluster</h1><span><time datetime=2020-11-16>November 16, 2020</time> <span class=reading-time>4 minute read</span></span><ul><li><a href=/topics/lnd/ >lnd</a></li><li><a href=/topics/simverse/ >simverse</a></li><li><a href=/topics/vscode/ >vscode</a></li></ul></header><section><p>If you want to debug LND, or if you want to take a real deep dive into LND, you probably want to be able to set breakpoints in the source code to see what is actually happening. Not only that, you also want to have the node run in a local cluster of other nodes, so that you can perform some real Lightning actions like opening a channel and make payments. This post takes you through the setup I use based on <a href=https://github.com/go-delve/delve>Delve</a> and <a href=https://github.com/darwin/simverse>Simverse</a>.</p><h2 id=setting-up-a-local-cluster-with-simverse>Setting up a local cluster with Simverse</h2><p>Simverse is an amazing tool for setting up local Lightning clusters. It uses docker-compose to manage the cluster and supports LND, c-lightning and Eclair nodes with either btcd or bitcoind back-ends. This makes it very easy to set up local clusters of any size, as long as your hardware can handle it. All nodes and back-ends are run in their own docker containers and are spun up on demand following a default recipe or a custom recipe that you can draft up yourself. It literally takes four commands to have a local cluster running with Simverse.</p><p>For our setup we will use a hybrid cluster. There are 3 types of Simverse clusters: Homogenous clusters are Simverse clusters that run either lnd + btcd nodes, eclair + bitcoind nodes or c-lightning + bitcoind nodes. More generally speaking, a homgenous cluster only contains one flavor of back-end and one flavor of Lightning node. The second type of cluster is heterogenous cluster, containing a mix of nodes and back-ends. The third type of cluster is called a hybrid cluster. This is a Simverse cluster (either homogenous or heterogenous) that interacts with an external node that runs directly on the host machine instead of in a docker container. We will use the default Simverse cluster (a homogenous lnd + btcd cluster) and make it hybrid by connecting the LND node that runs the code that we are going to debug.</p><p>Setting up the cluster with Simverse is not within the scope of this article, but the <a href=https://github.com/darwin/simverse>Quickstart</a> of Simverse is all you need to do. That will result in having a cluster with 3 Docker containers, two running LND, and one running a btcd back-end.</p><h2 id=building-lnd>Building LND</h2><p>We need to build de debug version of LND, to be able to do some debugging. I will be using the repo that Simverse automatically cloned. Simverse clones repos into the <code>_repos</code> folder inside the Simverse folder. In my case the Simverse folder is located here: <code>~/simverse/_repos</code>.</p><pre><code>cd ~/simverse/_repos/lnd
make build</code></pre><p>The resulting binaries can be found in the repo folder itself: <code>lnd-debug</code> and <code>lncli-debug</code></p><h2 id=create-a-lndconf-file>Create a lnd.conf file</h2><p>Yes, you can start lnd with a bunch of arguments. So there is no real need for a conf-file, but I think it makes it way easier to start LND with a conf-file. You can place your file anywhere, but I find it easy to have them all at a single place, and the most logical place is the default location: <code>~/.lnd/</code>.</p><p>Give it a name that makes it easy to understand that this is a conf file not be used in a production environment, like <code>lnd-test.conf</code>.</p><p>These are the contents of my <code>lnd-test.conf</code>:</p><pre><code>noseedbackup=true
bitcoin.active=true
bitcoin.regtest=true
no-macaroons=true
bitcoin.node=btcd
btcd.rpchost=default_btcd1
btcd.rpccert=/home/mini/simverse/_workspace/default/_volumes/certs/rpc.cert
btcd.rpcuser=devuser
btcd.rpcpass=devpass
debuglevel=debug</code></pre><p>What this configuration does is running LND with (completely unsafe) development settings, using the btcd Docker container as the back-end.</p><p>You would have to change <code>btcd.rpcert</code> to the path to the <code>rpc.cert</code> file in your Simverse workspace and you would probably have to change the <code>btcd.rpchost</code> as well. The <code>default_btcd1</code> host pointing to your btcd Docker container is <em>not</em> automatically added to your host file so either you have to add it to your host file or you have to replace it with an IP address. You can find the IP address of the btcd1 docker container of your Simverse cluster, by using the <code>list_docker_ips</code> command that ships with Simverse. (I told you that tool was amazing). An alternative solution is to run this <a href=https://github.com/dvddarias/docker-hoster>extra docker container</a> that automatically updates entries in your hostfile.</p><h2 id=installing-delve>Installing Delve</h2><p>Assuming you have Vscode installed, make sure you have installed the <a href="https://marketplace.visualstudio.com/items?itemName=golang.Go">language support for Go</a> extension.</p><p>Open the Command Palette, select <code>Go: Install/Update Tools</code>, and select <code>dlv</code></p><img src=/images/install-dlv.png width=850 alt="install dlv" title="Install dlv using the Command Palette"><h2 id=configure-launchjson>Configure launch.json</h2><p>Open the folder of your LND repo with Vscode and create a launch.json file by selecting the gear icon on the Run view (<kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>D</kbd>) top bar.</p><pre><code class=language-lang-json>{
    &quot;version&quot;: &quot;0.2.0&quot;,
    &quot;configurations&quot;: [
        {
            &quot;name&quot;: &quot;Launch lnd&quot;,
            &quot;type&quot;: &quot;go&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;mode&quot;: &quot;exec&quot;,
            &quot;program&quot;: &quot;${workspaceFolder}/lnd-debug&quot;,
            &quot;env&quot;: {},
            &quot;args&quot;: [&quot;--configfile=~/.lnd/lnd-test.conf&quot;],
            &quot;showLog&quot;: true
        }
    ]
}</code></pre><p>The args parameter should contain the location of your conf-file.</p><h2 id=set-breakpoints>Set breakpoints</h2><p>Now you are ready to set breakpoints, for instance in the <code>Main</code> function of the <code>lnd</code> package.</p><img src=/images/set-breakpoint.png width=850 alt="Main function" title="Main function"><p>If you start debugging, this breakpoint is immediately hit.</p><img src=/images/hit-breakpoint.png width=850 alt="Breakpoint hit" title="Breakpoint hit"><h2 id=done>Done!</h2><p>And there you have it, you can now start to debugging LND operating in a local cluster.</p></section></article></main><footer><nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/pages/research title=Research>Research</a></li><li><a href=/pages/opensource title="Open Source">Open Source</a></li><li><a href=/pages/ventures title=Ventures>Ventures</a></li><li><a href=/pages/resume title=Resume>Resume</a></li><li><a href=/pages/about title=About>About</a></li><li><a href=/pages/now title=Now>Now</a></li><li><a href=/pages/contact title=Contact>Contact</a></li></ul></nav><ul><li><a href=https://www.github.com/gijswijs rel="noreferrer noopener me" target=_blank title=Github>Github</a></li><li><a href=https://www.linkedin.com/in/gijsvandam/ rel="noreferrer noopener me" target=_blank title=LinkedIn>LinkedIn</a></li><li><a href=https://www.researchgate.net/profile/Gijs_Van_Dam2 rel="noreferrer noopener me" target=_blank title=ResearchGate>ResearchGate</a></li><li><a href=https://bitcoinhackers.org/@gijswijs rel="noreferrer noopener me" target=_blank title=Mastodon>Mastodon</a></li><li><a href=https://www.twitter.com/gijswijs rel="noreferrer noopener me" target=_blank title=Twitter>Twitter</a></li><li><a href=/rss.xml rel="noreferrer noopener me" target=_blank title=RSS>RSS</a></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://orcid.org/0000-0002-6188-6859 href=https://orcid.org/0000-0002-6188-6859 target=orcid.widget rel="me noopener noreferrer" style=vertical-align:top;>ORCID</a></div></li></ul><p>&copy; 2021 <a href=/ >Gijs van Dam</a>. Published with <a href=https://github.com/neumannjs/Janos>Janos</a>. Theme <a href=https://github.com/neumannjs/Miksa>Miksa</a>.</p></footer><script src=/scripts/vendor.js></script><script src=/scripts/app.js></script></body></html>