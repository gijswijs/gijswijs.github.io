<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content=""><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/ms-icon-144x144.png><meta name=theme-color content=#ffffff><title>Running c-lightning in Simverse with plugins</title><link href=/styles/main.css rel=stylesheet><link rel=webmention href=https://webmention.io/www.gijsvandam.nl/webmention><link rel=pingback href=https://webmention.io/www.gijsvandam.nl/xmlrpc></head><body class=article><header>Gijs van Dam<nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/pages/research title=Research>Research</a></li><li><a href=/pages/opensource title="Open Source">Open Source</a></li><li><a href=/pages/ventures title=Ventures>Ventures</a></li><li><a href=/pages/resume title=Resume>Resume</a></li><li><a href=/pages/about title=About>About</a></li><li><a href=/pages/now title=Now>Now</a></li><li><a href=/pages/contact title=Contact>Contact</a></li></ul></nav></header><main><article class=h-entry><header><h1 class=p-name>Running c-lightning in Simverse with plugins</h1><span><a class=u-url href=/posts/running-c-lightning-simverse-plugins><time class=dt-published datetime=2020-12-02T00:00:00Z>December 2, 2020</time></a> <span class=reading-time>4 minute read</span></span><ul><li><a class=p-category href=/topics/simverse/ >simverse</a></li><li><a class=p-category href=/topics/c-lightning/ >c-lightning</a></li></ul></header><section class=e-content><p>The goal is to run c-lightning with plugins in a local testing cluster. For my cluster I use <a href=https://github.com/darwin/simverse>Simverse</a>. Simverse allows for additional command line arguments to be passed to <code>lightningd</code>, so it should be possible to run <code>lightningd</code> with the <code>plugin</code> argument.</p><p>Let&#39;s first clone our plugin. We will be using one of the plugins that are available through Lightningd on Github.</p><pre><code>cd ~\simverse\_repos
git clone https://github.com/lightningd/plugins.git --depth 1</code></pre><p>We put the plugin in the <code>_repos</code> folder, because it is assumed that the plugin is there when the cluster is being build. (Also: throughout this article we assume your simverse folder is inside your home folder. If that is not the case, adjust it accordingly)</p><p>Since all nodes in Simverse run inside Docker containers, that plugin-file should be made available inside the Docker context folder. The <code>_repos</code> folder is not part of that context (each container gets its own context) so we have to copy the file from the <code>_repos</code> folder to the Docker context folder. Luckily Simverse works with the concept of recipes. A recipe describes how your cluster should look like. A recipe is a bash script that uses a library called cookbook that can be used to build your cluster step-by-step. Since it is &quot;just&quot; a bash script, you can do anything bash can do to tweak your cluster.</p><p>We will create a recipe that creates a cluster with three c-lightning nodes, running on a bitcoind back-end.</p><h2 id=simverse-recipe>Simverse Recipe</h2><pre><code class=language-bash>#!/usr/bin/env bash

. cookbook/cookbook.sh

prelude

add bitcoind

LIGHTNINGD_EXTRA_PARAMS=&#39;--plugin=/home/simnet/.lightning/plugins/jitrebalance.py&#39;

add lightningd alice
cp -r &quot;$SIMVERSE_REPOS/plugins/jitrebalance&quot; &quot;$SIMVERSE_WORKSPACE/$SIMNET_NAME/_volumes/lightning-data-alice/plugins&quot;

add lightningd bob
cp -r &quot;$SIMVERSE_REPOS/plugins/jitrebalance&quot; &quot;$SIMVERSE_WORKSPACE/$SIMNET_NAME/_volumes/lightning-data-bob/plugins&quot;

add lightningd charlie
cp -r &quot;$SIMVERSE_REPOS/plugins/jitrebalance&quot; &quot;$SIMVERSE_WORKSPACE/$SIMNET_NAME/_volumes/lightning-data-charlie/plugins&quot;


# generate init script to build connections
cat &gt; init &lt;&lt;EOF
#!/usr/bin/env bash

set -e -o pipefail

# connect LN nodes
connect alice charlie
connect charlie bob
connect bob alice
EOF
chmod +x init</code></pre><p>What is happening here? First we import the <code>cookbook</code> library. <code>prelude</code> does all the preliminary stuff needed for every cluster. After this we can start adding our back-end and our Lighning nodes. <code>add bitcoind</code> adds the bitoind node (duh!). Before we add our c-lightning nodes we set the <code>LIGHTNINGD_EXTRA_PARAMS</code> variable. This variable is passed to <code>lightningd</code> when starting up the Docker container. We use it to set the <code>plugin</code> argument.</p><p>We can now add our first lightning node, called &quot;alice&quot;: <code>add lightningd alice</code> After this we can copy our plugin to the Docker context folder with the following command:</p><pre><code class=language-bash>cp -r &quot;$SIMVERSE_REPOS/plugins/jitrebalance&quot; &quot;$SIMVERSE_WORKSPACE/$SIMNET_NAME/_volumes/lightning-data-alice/plugins&quot;</code></pre><p>We use several variables that may require some explanation. <code>$SIMVERSE_REPOS</code> holds the folder containing the Simverse repos. Since we have cloned our plugins repo into that folder, we can find it there. <code>$SIMVERSE_WORKSPACE</code> holds the folder where Simverse stores all the files required for creating a cluster. <code>$SIMNET_NAME</code> holds the name of the cluster. When we create a cluster based on this recipe, we also have to give that cluster a name. That name is available through the <code>$SIMNET_NAME</code> variable. The rest of theDocker context folder follows a simple naming convention: <code>_volumes/[node type]-[node name]</code></p><p>We do the same thing for Bob and Charlie.</p><p>The last part of our recipe can be left out if you want. It generates an initialization script that can be run after creating the cluster. In this case it connects the nodes, but you can also use it to fund nodes and make transactions, build multiple scripts and what not. It just shows how versatile Simverse is.</p><p>We can save our recipe. There are some simple naming conventions that you can follow that make easy to see what kind of back-end(s) and nodes this cluster uses:</p><ul><li><code>a</code>: bitcoind</li><li><code>b</code>: btcd</li><li><code>k</code>: lightningd</li><li><code>l</code>: lnd</li><li><code>m</code>: eclair</li></ul><p>So <code>a1k3</code> reads as &quot;one bitcoind node and two c-lightning nodes&quot;. You should use a postfix to identify any additional distinguishing features of the recipe. So in this case we save our recipe as <code>a1k3-plugin.sh</code> in the recipe folder of Simverse located at <code>~/simverse/recipes</code>.</p><h2 id=building-your-cluster>Building your cluster</h2><p>With our recipe out of the way we can create our cluster.</p><pre><code class=language-bash>cd ~/simverse
./sv create a1k3-plugin jitrebalance
./sv enter jitrebalance
./dc build
./dc up</code></pre><p>We have created a cluster named <code>jitrebalance</code>. This is the name of the cluster that we referenced in our recipe through the variable <code>$SIMNET_NAME</code>. Our cluster is based on the recipe <code>a1k3-plugin.sh</code> that we just created. With <code>enter</code> you enter your newly created simnet.</p><p><code>./dc</code> is a handy shorthand for <code>docker-compose</code> with some important variables set. With <code>build</code> we build our Docker containers based on the <code>docker-compose.yml</code> that has been generated for us. And then we are ready to run the containers with <code>up</code>.</p><p>You should see something like this:</p><p><picture><source srcset="/images/simverse-up_s.avif 540w,/images/simverse-up_m.avif 810w,/images/simverse-up_l.avif 1080w" type=image/avif><source srcset="/images/simverse-up_s.webp 540w,/images/simverse-up_m.webp 810w,/images/simverse-up_l.webp 1080w" type=image/webp><img srcset="/images/simverse-up_s.jpg 540w,/images/simverse-up_m.jpg 810w,/images/simverse-up_l.jpg 1080w" src=/images/simverse-up_s.jpg alt="running Simverse" title="Running a Simverse cluster" loading=lazy decoding=async width=1080 height=610><figcaption>Running a Simverse cluster</figcaption></picture></p><p>Now in a separate terminal session you can access your nodes and run the <code>init</code> script.</p><pre><code class=language-bash>cd ~/simverse
./sv enter jitrebalance
./init</code></pre><p><picture><source srcset="/images/simverse-init_s.avif 540w,/images/simverse-init_m.avif 810w,/images/simverse-init_l.avif 1080w" type=image/avif><source srcset="/images/simverse-init_s.webp 540w,/images/simverse-init_m.webp 810w,/images/simverse-init_l.webp 1080w" type=image/webp><img srcset="/images/simverse-init_s.jpg 540w,/images/simverse-init_m.jpg 810w,/images/simverse-init_l.jpg 1080w" src=/images/simverse-init_s.jpg alt="running init" title="Running the initialization script" loading=lazy decoding=async width=1080 height=410><figcaption>Running the initialization script</figcaption></picture></p><p>And with that you are done! You have now a Simverse cluster with three c-lightning nodes running the same plugin.</p></section></article></main><footer><nav><ul><li><a href=/ title=Home>Home</a></li><li><a href=/pages/research title=Research>Research</a></li><li><a href=/pages/opensource title="Open Source">Open Source</a></li><li><a href=/pages/ventures title=Ventures>Ventures</a></li><li><a href=/pages/resume title=Resume>Resume</a></li><li><a href=/pages/about title=About>About</a></li><li><a href=/pages/now title=Now>Now</a></li><li><a href=/pages/contact title=Contact>Contact</a></li></ul></nav><ul><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.github.com/gijswijs href=https://www.github.com/gijswijs rel="noreferrer noopener me" target=_blank title=Github>Github</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.linkedin.com/in/gijsvandam/ href=https://www.linkedin.com/in/gijsvandam/ rel="noreferrer noopener me" target=_blank title=LinkedIn>LinkedIn</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.researchgate.net/profile/Gijs_Van_Dam2 href=https://www.researchgate.net/profile/Gijs_Van_Dam2 rel="noreferrer noopener me" target=_blank title=ResearchGate>ResearchGate</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://bitcoinhackers.org/@gijswijs href=https://bitcoinhackers.org/@gijswijs rel="noreferrer noopener me" target=_blank title=Mastodon>Mastodon</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://www.twitter.com/gijswijs href=https://www.twitter.com/gijswijs rel="noreferrer noopener me" target=_blank title=Twitter>Twitter</a></div></li><li><a href=/rss.xml rel="" target=_blank title=RSS>RSS</a></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://keybase.io/gijsvandam href=https://keybase.io/gijsvandam rel="noreferrer noopener me" target=_blank title=Keybase>Keybase</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content=https://orcid.org/0000-0002-6188-6859 href=https://orcid.org/0000-0002-6188-6859 rel="noreferrer noopener me" target=_blank title=ORCID>ORCID</a></div></li><li><div itemscope itemtype=https://schema.org/Person><a itemprop=sameAs content="https://scholar.google.com/citations?user=4dTcK4kAAAAJ&amp;hl=en" href="https://scholar.google.com/citations?user=4dTcK4kAAAAJ&amp;hl=en" rel="noreferrer noopener me" target=_blank title="Google Scholar">Google Scholar</a></div></li></ul><p>&copy; 2021 <a rel=author href=/ >Gijs van Dam</a>. Published with <a href=https://github.com/neumannjs/Janos>Janos</a>. Theme <a href=https://github.com/neumannjs/Miksa>Miksa</a>.</p></footer></body><script data-goatcounter=https://gijsvandam.goatcounter.com/count async src=//gc.zgo.at/count.js></script></html>